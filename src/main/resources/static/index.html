<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>42Cabi - Backend Test</title>
    <style>
        body { font-family: sans-serif; padding: 20px; text-align: center; }
        button { padding: 10px 20px; font-size: 16px; cursor: pointer; margin: 10px; }
        .box { border: 1px solid #ddd; padding: 20px; margin: 20px auto; max-width: 600px; border-radius: 10px; background-color: #f9f9f9; }
        #token-area { word-break: break-all; color: green; font-size: 12px; margin: 10px 0; background: #e8f5e9; padding: 10px; border-radius: 5px;}
        #result { margin-top: 20px; font-weight: bold; color: blue; white-space: pre-wrap; text-align: left; background: #e3f2fd; padding: 15px; border-radius: 5px;}
        .error { color: red !important; background: #ffebee !important; }
        hr { margin: 20px 0; border: 0; border-top: 1px solid #ccc; }
    </style>
</head>
<body>

<h1>ğŸ” 42Cabi í†µí•© í…ŒìŠ¤íŠ¸ (Ver 3.5)</h1>

<div class="box">
    <h3>1. ì¸ì¦ ìƒíƒœ</h3>
    <div id="token-display">ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.</div>

    <a href="/oauth2/authorization/42">
        <button style="background-color: #00babc; color: white; border: none;">
            ğŸš€ 42 Login
        </button>
    </a>
    <button onclick="reissueToken()" style="background-color: #ff9800; color: white; border: none;">
        ğŸ”„ í† í° ì¬ë°œê¸‰ (Refresh)
    </button>
</div>

<div class="box">
    <h3>2. ì¼ë°˜ ê¸°ëŠ¥ í…ŒìŠ¤íŠ¸</h3>
    <button onclick="requestApi('POST', '/v4/store/buy/1')">ğŸ›’ ì•„ì´í…œ êµ¬ë§¤</button>
    <button onclick="requestApi('POST', '/v4/lent/cabinets/1')">ğŸ”‘ ì‚¬ë¬¼í•¨ ëŒ€ì—¬</button>
    <button onclick="requestApi('POST', '/v4/lent/return')">â†©ï¸ ì‚¬ë¬¼í•¨ ë°˜ë‚©</button>

    <hr>
    <h3>3. ê´€ë¦¬ì ê¸°ëŠ¥ (DB ê¶Œí•œ ë³€ê²½ í•„ìˆ˜)</h3>
    <button onclick="requestApi('POST', '/admin/test/coins')" style="background-color: #d32f2f; color: white; border: none;">
        ğŸ‘®â€â™‚ï¸ [ê´€ë¦¬ì] ì „ ìœ ì € ì½”ì¸ ì§€ê¸‰ (Logtime)
    </button>
</div>

<div class="box">
    <h3>4. ê²°ê³¼ ë¡œê·¸</h3>
    <div id="result">ë²„íŠ¼ì„ ëˆ„ë¥´ë©´ ê²°ê³¼ê°€ í‘œì‹œë©ë‹ˆë‹¤.</div>
</div>

<script>
    let jwtToken = null;

    // 1. í˜ì´ì§€ ë¡œë“œ ì‹œ URLì—ì„œ í† í° ì°¾ê¸°
    window.onload = function() {
        const urlParams = new URLSearchParams(window.location.search);
        const token = urlParams.get('token');

        if (token) {
            setToken(token);
            window.history.replaceState({}, document.title, "/"); // URL ì •ë¦¬
        }
    };

    function setToken(token) {
        jwtToken = token;
        document.getElementById('token-display').innerHTML =
            `âœ… <b>ì¸ì¦ë¨!</b><br>(Access Token ë³´ìœ  ì¤‘)<div id="token-area">${token}</div>`;
    }

    // 2. API ìš”ì²­ (JSON / Text ëª¨ë‘ ì²˜ë¦¬í•˜ë„ë¡ ê°œì„ )
    function requestApi(method, url) {
        if (!jwtToken) {
            alert("ë¨¼ì € ë¡œê·¸ì¸ì„ í•˜ê±°ë‚˜ í† í°ì„ ì¬ë°œê¸‰ ë°›ìœ¼ì„¸ìš”!");
            return;
        }

        document.getElementById('result').innerText = "â³ ìš”ì²­ ì¤‘...";

        fetch(url, {
            method: method,
            headers: {
                'Authorization': 'Bearer ' + jwtToken
            }
        })
            .then(async response => {
                const text = await response.text(); // ì¼ë‹¨ í…ìŠ¤íŠ¸ë¡œ ë°›ìŒ

                // ì—ëŸ¬ ìƒíƒœ ì½”ë“œ ì²˜ë¦¬
                if (!response.ok) {
                    document.getElementById('result').className = "error";
                    // JSONì´ë©´ íŒŒì‹±í•´ì„œ ë³´ì—¬ì£¼ê³ , ì•„ë‹ˆë©´ ê·¸ëƒ¥ ë³´ì—¬ì¤Œ
                    try {
                        const json = JSON.parse(text);
                        document.getElementById('result').innerText = `ğŸš¨ ì˜¤ë¥˜ (${response.status}):\n` + JSON.stringify(json, null, 2);
                    } catch (e) {
                        document.getElementById('result').innerText = `ğŸš¨ ì˜¤ë¥˜ (${response.status}):\n` + text;
                    }
                    return;
                }

                // ì„±ê³µ ì²˜ë¦¬
                document.getElementById('result').className = "";
                try {
                    // JSON ë³€í™˜ ì‹œë„
                    const json = JSON.parse(text);
                    document.getElementById('result').innerText = JSON.stringify(json, null, 2);
                } catch (e) {
                    // JSONì´ ì•„ë‹ˆë©´ ê·¸ëƒ¥ í…ìŠ¤íŠ¸ë¡œ ì¶œë ¥ (AdminController ì‘ë‹µìš©)
                    document.getElementById('result').innerText = text;
                }
            })
            .catch(err => {
                document.getElementById('result').className = "error";
                document.getElementById('result').innerText = "í†µì‹  ì—ëŸ¬: " + err;
            });
    }

    // 3. í† í° ì¬ë°œê¸‰ ìš”ì²­
    function reissueToken() {
        fetch('/v4/auth/reissue', {
            method: 'POST'
        })
            .then(response => response.json())
            .then(data => {
                if (data.accessToken) {
                    setToken(data.accessToken);
                    document.getElementById('result').className = "";
                    document.getElementById('result').innerText = "ğŸ‰ í† í° ì¬ë°œê¸‰ ì„±ê³µ! (ìœ íš¨ê¸°ê°„ ì—°ì¥ë¨)";
                } else {
                    document.getElementById('result').className = "error";
                    document.getElementById('result').innerText = "ì¬ë°œê¸‰ ì‹¤íŒ¨: " + JSON.stringify(data);
                }
            })
            .catch(err => {
                document.getElementById('result').className = "error";
                document.getElementById('result').innerText = "ì¬ë°œê¸‰ ì—ëŸ¬: " + err;
            });
    }
</script>
</body>
</html>